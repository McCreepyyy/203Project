<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Duolingo ー Lesson Hub</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/bird.png') }}" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap">
    <link rel="stylesheet" href="{{ url_for('static', filename='lessonhub.css') }}" />
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <a href="{{ url_for('lessonhub') }}" class="logo-link">
            <img src="{{ url_for('static', filename='images/duolingo2.png') }}" alt="Duolingo" class="logo-image" style="width:120px;height:30px;" draggable="false" />
        </a>
        <a href="{{ url_for('lessonhub') }}" class="sidebar-link">
            <img src="{{ url_for('static', filename='images/learn.png') }}" alt="Learn" style="width: 35px; height: 35px;" draggable="false" />
            <b>Learn</b>
        </a>
        <a href="{{ url_for('characters') }}" class="sidebar-link">
            <img src="{{ url_for('static', filename='images/characters.png') }}" alt="Characters" style="width: 35px; height: 35px;" draggable="false" />
            <b>Characters</b>
        </a>
        <a href="{{ url_for('leaderboards') }}" class="sidebar-link">
            <img src="{{ url_for('static', filename='images/leaderboards.png') }}" alt="Leaderboards" style="width: 35px; height: 35px;" draggable="false" />
            <b>Leaderboard</b>
        </a>
        <a href="{{ url_for('quests') }}" class="sidebar-link">
            <img src="{{ url_for('static', filename='images/quests.png') }}" alt="Quests" style="width: 35px; height: 35px;" draggable="false" />
            <b>Quests</b>
        </a>
        <a href="{{ url_for('shop') }}" class="sidebar-link">
            <img src="{{ url_for('static', filename='images/shop.png') }}" alt="Shop" style="width: 35px; height: 35px;" draggable="false" />
            <b>Shop</b>
        </a>
        <a href="{{ url_for('profile') }}" class="sidebar-link">
            <img src="{{ url_for('static', filename='images/profile.png') }}" alt="Profile" style="width: 35px; height: 35px;" draggable="false" />
            <b>Profile</b>
        </a>
        <a href="{{ url_for('settings') }}" class="sidebar-link">
            <img src="{{ url_for('static', filename='images/settings.png') }}" alt="Settings" style="width: 35px; height: 35px;" draggable="false" />
            <b>Settings</b>
        </a>
        <a href="{{ url_for('index') }}" class="sidebar-link">
            <img src="{{ url_for('static', filename='images/signout.png') }}" alt="Sign Out" style="width: 35px; height: 35px;" draggable="false" />
            <b>Sign Out</b>
        </a>
    </div>

    <!-- Content -->
    <div class="content">
        <!-- Navigation Bar -->
        <nav class="menu">
            <div style="position:relative; left: 50px; bottom: 15px;"></div>

            <ul>
                <li class="language">
                    <div class="dropdown">
                        <button class="dropbtn" onclick="toggleDropdown()"><b>SITE LANGUAGE: ENGLISH</b><span class="arrow">&#9662;</span></button>
                        <div class="dropdown-content" id="dropdownContent">
                            <a href="{{ url_for('lessonhub') }}"><img src="{{ url_for('static', filename='images/flag_en.png') }}" alt="English" class="flag" draggable="false" />English</a>
                            <a href="{{ url_for('lessonhubjp') }}"><img src="{{ url_for('static', filename='images/flag_jp.png') }}" alt="Japanese" class="flag" draggable="false" />日本語</a>
                            <a href="{{ url_for('lessonhubfr') }}"><img src="{{ url_for('static', filename='images/flag_fr.png') }}" alt="French" class="flag" draggable="false" />French</a>
                        </div>
                    </div>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Hearts, Day Streak, Gems -->
        <div class="header-icons">
            <div class="hearts">
                <img src="{{ url_for('static', filename='images/hearts.png') }}" alt="Hearts" draggable="false" />
                <span id="heartsCount">{{ user.hearts }}</span>
            </div>
            <div class="day-streak">
                <img src="{{ url_for('static', filename='images/daystreak.png') }}" alt="Day Streak" draggable="false" />
                <span id="streakCount">{{ user.day_streak }}</span>
            </div>
            <div class="gems">
                <img src="{{ url_for('static', filename='images/gems.png') }}" alt="Gems" draggable="false" />
                <span id="gemsCount">{{ user.gems }}</span>
            </div>
        </div>

        <!-- Main Content -->
        <section class="lessons">
            <h1>TRANSLATE THESE QUESTIONS</h1>
            <div id="hearts-container"></div>
            <div id="question-container" class="question-container hidden">
                <div class="question">
                    <p id="question-text"></p>
                    <div id="answer-buttons" class="multiple-choice"></div>
                </div>
                <div id="feedback" class="feedback hidden"></div>
            </div>
            <button id="next-button" class="hidden">Next</button>
        </section>
</div>
        
        <aside class="sidebar-right">
            <div class="league">
                <h3>LEADERBOARD</h3>
                <!-- Leaderboard List -->
                <ol>
                    {% for user in top_users %}
                    <li>{{ user.username }} - {{ user.xp }} XP</li>
                    {% endfor %}
                </ol>
                <a href="{{ url_for('leaderboards') }}" class="leaderboard-link"><b>View League</b></a>
            </div>
            <div class="daily-quests">
                <h3>DAILY QUESTS</h3>
                <div class="quest">
                    <p>Earn 50 XP</p>
                    <div class="progress">
                        <div class="progress-bar"></div>
                    </div>
                </div>
                <div class="quest">
                    <p>Complete 2 perfect lessons</p>
                    <div class="progress">
                        <div class="progress-bar"></div>
                    </div>
                </div>
                <div class="quest">
                    <p>Get 10 in a row correct in 4 lessons</p>
                    <div class="progress">
                        <div class="progress-bar"></div>
                    </div>
                </div>
            </div>
        </aside>
    </div>



    <script>

  function toggleDropdown() {
      var dropdown = document.getElementById("dropdownContent");
      dropdown.classList.toggle("active");
  }

        // Fetch the current user's hearts from the server
        function fetchHearts() {
            fetch('/get_user_hearts')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        heartsCount = data.hearts; // Set heartsCount to the number of hearts from the server
                        updateHearts();
                    } else {
                        console.error('Failed to fetch hearts');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function updateHearts() {
            document.getElementById("heartsCount").innerText = heartsCount;
        }

        function loseHeart() {
            if (heartsCount > 0) {
                heartsCount--;
                updateHearts();
                // Call the Flask route to update the hearts in the database
                fetch('/lose_heart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log(`Hearts left: ${data.hearts}`);
                        } else {
                            console.error('Failed to update hearts');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }
        }

        function regenerateHeart() {
            // This function should also call a server route to increment the heart count in the database
        }

        // Call function to fetch and initialize hearts count from the server
        fetchHearts();



    const questions = [
        { text: 'Translate すし、ごはん', answers: ['sushi, rice', 'sushi, water', 'sushi, green tea'], correct: 'sushi, rice' },
        { text: 'Translate すし、みず', answers: ['sushi, rice', 'sushi, water', 'sushi, green tea'], correct: 'sushi, water' },
        { text: 'Translate すし、おちゃ', answers: ['sushi, rice', 'sushi, water', 'sushi, green tea'], correct: 'sushi, green tea' },
        { text: 'Translate ごはん、みず', answers: ['rice, water', 'rice, green tea', 'sushi, rice'], correct: 'rice, water' },
        { text: 'Translate ごはん、おちゃ', answers: ['rice, water', 'rice, green tea', 'sushi, rice'], correct: 'rice, green tea' },
        { text: 'Translate すしとごはん、ください', answers: ['sushi and rice, please', 'sushi and water, please', 'sushi and green tea, please'], correct: 'sushi and rice, please' },
        { text: 'Translate すしとみず、ください', answers: ['sushi and rice, please', 'sushi and water, please', 'sushi and green tea, please'], correct: 'sushi and water, please' },
        { text: 'Translate すしとおちゃ、ください', answers: ['sushi and rice, please', 'sushi and water, please', 'sushi and green tea, please'], correct: 'sushi and green tea, please' },
        { text: 'Translate ごはんとみず、ください', answers: ['rice and water, please', 'rice and green tea, please', 'sushi and rice, please'], correct: 'rice and water, please' },
        { text: 'Translate ごはんとおちゃ、ください', answers: ['rice and water, please', 'rice and green tea, please', 'sushi and rice, please'], correct: 'rice and green tea, please' },
        { text: 'Translate すしとごはんです', answers: ["it's sushi and rice", "it's sushi and water", "it's sushi and green tea"], correct: "it's sushi and rice" },
        { text: 'Translate すしとみずです', answers: ["it's sushi and rice", "it's sushi and water", "it's sushi and green tea"], correct: "it's sushi and water" },
        { text: 'Translate すしとおちゃです', answers: ["it's sushi and rice", "it's sushi and water", "it's sushi and green tea"], correct: "it's sushi and green tea" },
        { text: 'Translate ごはんとみずです', answers: ["it's rice and water", "it's rice and green tea", "it's sushi and rice"], correct: "it's rice and water" },
        { text: 'Translate ごはんとおちゃです', answers: ["it's rice and water", "it's rice and green tea", "it's sushi and rice"], correct: "it's rice and green tea" },
    ];

    let currentQuestionIndex = 0;
    let score = 0;
    let hearts = 5;

    const questionContainer = document.getElementById('question-container');
    const questionText = document.getElementById('question-text');
    const answerButtons = document.getElementById('answer-buttons');
    const feedback = document.getElementById('feedback');
    const nextButton = document.getElementById('next-button');
    const heartsContainer = document.getElementById('hearts-container');

    function startGame() {
        score = 0;
        hearts = 5;
        currentQuestionIndex = 0;
        heartsContainer.innerHTML = '';
        for (let i = 0; i < hearts; i++) {
            const heart = document.createElement('div');
            heart.classList.add('heart');
            heartsContainer.appendChild(heart);
        }
        nextButton.classList.add('hidden');
        showQuestion();
    }

    function showQuestion() {
        resetState();
        questionContainer.classList.remove('hidden');
        feedback.classList.add('hidden');
        const question = questions[currentQuestionIndex];
        questionText.innerText = question.text;
        question.answers.forEach(answer => {
            const button = document.createElement('button');
            button.innerText = answer;
            button.classList.add('btn');
            button.dataset.correct = answer === question.correct;
            button.addEventListener('click', selectAnswer);
            answerButtons.appendChild(button);
        });
    }

    function resetState() {
        while (answerButtons.firstChild) {
            answerButtons.removeChild(answerButtons.firstChild);
        }
        nextButton.classList.add('hidden');
        feedback.classList.add('hidden');
    }

   function selectAnswer(e) {
            const selectedButton = e.target;
            const correct = selectedButton.dataset.correct === 'true';
            if (correct) {
                feedback.innerText = 'Correct!';
                feedback.classList.remove('incorrect');
                feedback.classList.add('correct');
                score += 10;
            } else {
                feedback.innerText = 'Incorrect!';
                feedback.classList.remove('correct');
                feedback.classList.add('incorrect');
                hearts--;
                heartsContainer.removeChild(heartsContainer.lastChild);
                // Call the Flask route to update the hearts in the database
                fetch('/lose_heart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log(`Hearts left: ${data.hearts}`);
                            if (data.locked) {
                                // Redirect the user or show a message that they are locked out
                                window.location.href = "{{ url_for('lessonhub') }}";
                            }
                        } else {
                            console.error('Failed to update hearts');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }
            feedback.classList.remove('hidden');
            nextButton.classList.remove('hidden');
            Array.from(answerButtons.children).forEach(button => {
                button.disabled = true;
                setStatusClass(button, button.dataset.correct === 'true');
            });
            if (hearts === 0) {
                feedback.innerText = 'Game Over';
                nextButton.innerText = 'OK';
                nextButton.classList.remove('hidden');
                nextButton.removeEventListener('click', nextQuestion);
                nextButton.addEventListener('click', () => {
                    window.location.href = "{{ url_for('lessonhub') }}";
                });
            }
        }

    function setStatusClass(element, correct) {
        if (correct) {
            element.classList.add('correct');
        } else {
            element.classList.add('incorrect');
        }
    }

    function nextQuestion() {
        currentQuestionIndex++;
        if (currentQuestionIndex < 5) {
            showQuestion();
        } else {
            feedback.innerText = `Lesson complete! You earned ${score} XP`;
            updateXP(score);
            nextButton.innerText = 'OK';
            nextButton.classList.remove('hidden');
            nextButton.removeEventListener('click', nextQuestion);
            nextButton.addEventListener('click', () => {
                window.location.href = "{{ url_for('lessonhub') }}";
            });
        }
    }

    function updateXP(xp) {
        fetch('/update_xp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ xp: xp }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(`New XP: ${data.new_xp}`);
            } else {
                console.error('Failed to update XP');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    nextButton.addEventListener('click', nextQuestion);

    startGame();
    </script>
    </body>
</html>
